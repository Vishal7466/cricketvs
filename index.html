<script>
const CRIC_API_KEY = "d148671e-e9db-4319-af93-ff76a71b62da";
const NEWS_API_KEY = "pub_59e3548735964cd18ebc211a3b466d9d";

const liveScoreContainer = document.getElementById("live-score");

// 1Ô∏è‚É£ Main Function
async function fetchLiveMatches() {
  liveScoreContainer.innerHTML = "<em>Loading live matches...</em>";

  try {
    const res = await fetch(`https://api.cricapi.com/v1/currentMatches?apikey=${CRIC_API_KEY}`);
    const data = await res.json();
    const matches = data?.data || [];

    if (!matches.length) {
      console.log("No live matches found ‚Üí switching to NewsData.io");
      await fetchCricketNewsFallback();
      return;
    }

    // Filter only live (started and not ended)
    const liveMatches = matches.filter(m => m.matchStarted && !m.matchEnded);

    if (!liveMatches.length) {
      console.log("No active live matches ‚Üí loading news fallback");
      await fetchCricketNewsFallback();
      return;
    }

    let html = "";
    for (const match of liveMatches) {
      html += await renderMatchScorecard(match);
    }

    liveScoreContainer.innerHTML = html;
  } catch (err) {
    console.error("CricAPI Error:", err);
    liveScoreContainer.innerHTML = "<p>‚ö†Ô∏è CricAPI Error ‚Äî trying backup news...</p>";
    await fetchCricketNewsFallback();
  }
}

// 2Ô∏è‚É£ Match Scorecard Function
async function renderMatchScorecard(match) {
  try {
    const res = await fetch(`https://api.cricapi.com/v1/match_scorecard?apikey=${CRIC_API_KEY}&id=${match.id}`);
    const data = await res.json();
    const scoreData = data?.data || {};

    const team1 = match.teamInfo?.[0];
    const team2 = match.teamInfo?.[1];
    const venue = match.venue || "‚Äî";
    const status = match.status || "Live";

    let inningsHTML = "";

    // Each inning with batsmen + bowlers
    (scoreData.scorecard || []).forEach(inning => {
      inningsHTML += `
        <div style="margin-top:8px;padding:10px;border:1px solid #e5e7eb;border-radius:8px;">
          <strong>${inning.inning}</strong><br>
          <span style="font-size:14px;color:#475569;">
            ${inning.runs}/${inning.wickets} (${inning.overs} ov)
          </span>

          <div style="margin-top:6px;">
            <b>Batsmen:</b>
            <ul style="margin:4px 0 0 16px;font-size:13px;color:#475569;">
              ${inning.batsmen?.map(b => 
                `<li>${b.batsman}: ${b.runs} (${b.balls}) ${b['4s']}√ó4 ${b['6s']}√ó6</li>`
              ).join('') || '<li>No data</li>'}
            </ul>
          </div>

          <div style="margin-top:6px;">
            <b>Bowlers:</b>
            <ul style="margin:4px 0 0 16px;font-size:13px;color:#475569;">
              ${inning.bowlers?.map(b => 
                `<li>${b.bowler}: ${b.wickets}/${b.runs} (${b.overs} ov)</li>`
              ).join('') || '<li>No data</li>'}
            </ul>
          </div>
        </div>
      `;
    });

    return `
      <div style="border:1px solid #e2e8f0;padding:14px;border-radius:10px;margin-bottom:14px;background:#fff;">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:8px;">
            <img src="${team1?.img || ''}" width="36" height="36" style="border-radius:4px"/>
            <strong>${team1?.name || ''}</strong>
            <span style="margin:0 6px;font-weight:600;">vs</span>
            <img src="${team2?.img || ''}" width="36" height="36" style="border-radius:4px"/>
            <strong>${team2?.name || ''}</strong>
          </div>
          <span style="color:#e11d48;font-weight:600;">üî¥ LIVE</span>
        </div>
        <div style="margin-top:6px;">${inningsHTML}</div>
        <div style="margin-top:4px;color:#0369a1;font-weight:500;">${status}</div>
        <div style="margin-top:3px;font-size:13px;color:#64748b">${venue}</div>
      </div>
    `;
  } catch (err) {
    console.error("Error fetching scorecard:", err);
    return `<div>‚ö†Ô∏è Unable to load scorecard for ${match.name}</div>`;
  }
}

// 3Ô∏è‚É£ Fallback ‚Üí NewsData.io
async function fetchCricketNewsFallback() {
  try {
    const res = await fetch(
      `https://newsdata.io/api/1/news?apikey=${NEWS_API_KEY}&q=cricket+live+match&language=en&category=sports`
    );
    const data = await res.json();
    const articles = data.results || [];

    if (!articles.length) {
      liveScoreContainer.innerHTML = "<em>No live cricket news available currently.</em>";
      return;
    }

    let html = `<h3>üì∞ Latest Cricket Live Updates</h3>`;
    articles.slice(0, 6).forEach(a => {
      html += `
        <a href="${a.link}" target="_blank" 
           style="display:block;padding:10px;margin-bottom:8px;border:1px solid #e5e7eb;
                  border-radius:8px;background:#fff;text-decoration:none;color:#111;">
          <div style="font-size:13px;color:#64748b">${new Date(a.pubDate).toLocaleString()}</div>
          <strong>${a.title}</strong>
          <p style="font-size:14px;color:#475569;">${a.description || ""}</p>
        </a>`;
    });

    liveScoreContainer.innerHTML = html;
  } catch (err) {
    console.error("NewsData Error:", err);
    liveScoreContainer.innerHTML = "<p>‚ö†Ô∏è Unable to fetch cricket news.</p>";
  }
}

// 4Ô∏è‚É£ Auto-refresh every 3 minutes
fetchLiveMatches();
setInterval(fetchLiveMatches, 180000);
</script>
